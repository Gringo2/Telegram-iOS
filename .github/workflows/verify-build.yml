name: Verify Liquid Glass Build

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  ios-build:
    name: Build & Check Syntax
    runs-on: macos-14

    steps:
      # 1. Checkout Code (DISABLE submodules here)
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 1

      # 2. Fix Submodule URLs (Required for Forks)
      - name: Redirect Submodule URLs
        run: |
          git config --global url."https://github.com/TelegramMessenger/".insteadOf "https://github.com/${{ github.repository_owner }}/"
          git submodule update --init --recursive

      # 3. Apply Liquid Glass Patch
      - name: Apply Liquid Glass Patch
        run: |
          git apply --ignore-space-change --ignore-whitespace --verbose liquid_glass_contest.patch || { echo "Patch failed"; exit 1; }
          echo "Patch applied successfully!"

      # 4. Install Dependencies (FIXED for macOS 14)
      - name: Install Build Tools
        run: |
          brew install cmake yasm
          # usage of --break-system-packages is required on macOS 14+ runners
          pip3 install --user ply --break-system-packages

      # 5. Setup Fake Code Signing (STOLEN FROM THEIR FILE)
      # This imports the dummy certificates included in the repo
      - name: Setup Fake Certs
        run: |
          python3 build-system/Make/ImportCertificates.py --path build-system/fake-codesigning/certs

      # 6. Bypass Xcode 26.0 Requirement (FIXED)
      # Only patch Python files to avoid "illegal byte sequence" errors on binaries
      - name: Bypass Xcode Requirement
        run: |
          echo "Hunting down the Xcode 26.0 check..."
          
          # Find only .py files and replace 26.0 with 15.0
          find build-system -name "*.py" -print0 | xargs -0 sed -i '' 's/26\.0/15.0/g'
          find build-system -name "*.py" -print0 | xargs -0 sed -i '' 's/(26, 0)/(15, 0)/g'
          
          echo "Patched Python build scripts."

      # 7. Configure Telegram
      - name: Configure Telegram
        run: |
          mkdir -p build-system
          echo '{
            "api_id": "${{ secrets.TELEGRAM_API_ID }}",
            "api_hash": "${{ secrets.TELEGRAM_API_HASH }}",
            "is_internal_build": false,
            "is_appstore_build": false,
            "appstore_id": "123456789",
            "app_specific_url_scheme": "tg",
            "premium_bundle_id": "org.telegram.Telegram-iOS.Premium",
            "team_id": "ABCDE12345"
          }' > build-system/telegram-configuration.json

      # 8. Generate Xcode Project (Fixed with Fake Signing)
      - name: Generate Xcode Project
        run: |
          python3 build-system/Make/Make.py \
            generateProject \
            --configurationPath=build-system/telegram-configuration.json \
            --codesigningInformationPath=build-system/fake-codesigning \
            --disableProvisioningProfiles

      # 9. Verify Compilation
      - name: Verify Compilation (TelegramUI)
        run: |
          xcodebuild build \
            -workspace Telegram.xcworkspace \
            -scheme TelegramUI \
            -destination 'generic/platform=iOS Simulator' \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty
