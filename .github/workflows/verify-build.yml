name: Verify Liquid Glass Build

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  ios-build:
    name: Build & Check Syntax
    runs-on: macos-14

    steps:
      # 1. Checkout Code (DISABLE submodules here)
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 1

      # 2. Fix Submodule URLs (Required for Forks)
      - name: Redirect Submodule URLs
        run: |
          git config --global url."https://github.com/TelegramMessenger/".insteadOf "https://github.com/${{ github.repository_owner }}/"
          git submodule update --init --recursive

      # 3. Apply Liquid Glass Patch
      - name: Apply Liquid Glass Patch
        run: |
          git apply --ignore-space-change --ignore-whitespace --verbose liquid_glass_contest.patch || { echo "Patch failed"; exit 1; }
          echo "Patch applied successfully!"

      # 4. Install Dependencies (FIXED for macOS 14)
      - name: Install Build Tools
        run: |
          brew install cmake yasm
          # usage of --break-system-packages is required on macOS 14+ runners
          pip3 install --user ply --break-system-packages

      # 5. Setup Fake Code Signing (STOLEN FROM THEIR FILE)
      # This imports the dummy certificates included in the repo
      - name: Setup Fake Certs
        run: |
          # FIX: One profile is misplaced in the repo root
          echo "Moving misplaced BroadcastUpload profile..."
          mv build-system/fake-codesigning/BroadcastUpload.mobileprovision build-system/fake-codesigning/profiles/ || true
          
          python3 build-system/Make/ImportCertificates.py --path build-system/fake-codesigning/certs
          
      # 5b. Remove .icon bundles (Requires Xcode 26)
      - name: Remove Xcode 26 Icon Bundles
        run: |
          echo "Removing .icon bundles from Telegram/BUILD..."
          sed -i '' 's/composer_icon_folders = \["Telegram"\]/composer_icon_folders = []/' Telegram/BUILD
          grep "composer_icon_folders" Telegram/BUILD

      # 5c. Downgrade Swift Tools Version (Fix 6.0 vs 5.10 mismatch)
      - name: Downgrade Swift Tools Version
        run: |
          echo "Downgrading Swift tools version in XcodeParse/Package.swift..."
          sed -i '' 's/swift-tools-version: 6.0/swift-tools-version: 5.10/' build-system/XcodeParse/Package.swift
          # Also downgrade XcodeProj from 9.0.0 (requires Swift 6) to 8.20.0
          sed -i '' 's/exact: "9.0.0"/exact: "8.20.0"/' build-system/XcodeParse/Package.swift
          cat build-system/XcodeParse/Package.swift

      # 5d. Fix XcodeParse Rewrite Error (Any to String cast)
      - name: Fix XcodeParse Compilation
        run: |
          echo "Patching XcodeParse/Sources/main.swift to cast Any to String..."
          # Replace .stringValue with as? String
          sed -i '' 's/\?\.stringValue/ as? String/g' build-system/XcodeParse/Sources/main.swift
          grep "as? String" build-system/XcodeParse/Sources/main.swift

      # 6. Bypass Xcode 26.0 Requirement (FIXED - VERSIONS.JSON)
      # 6. Bypass Xcode 26.0 Requirement (FIXED - VERSIONS.JSON)
      - name: Bypass Xcode Requirement
        run: |
          echo "Patching versions.json..."
          # Replace "26.0" with "15.4" to match the runner's Xcode version
          sed -i '' 's/"xcode": "26.0"/"xcode": "15.4"/' versions.json
          cat versions.json

      # 7. Configure Telegram
      - name: Configure Telegram
        run: |
          mkdir -p build-system
          echo '{
            "bundle_id": "ph.telegra.Telegraph",
            "api_id": "${{ secrets.TELEGRAM_API_ID }}",
            "api_hash": "${{ secrets.TELEGRAM_API_HASH }}",
            "team_id": "C67CF9S4VU",
            "app_center_id": "0",
            "is_internal_build": false,
            "is_appstore_build": false,
            "appstore_id": "686449807",
            "app_specific_url_scheme": "tg",
            "premium_iap_product_id": "org.telegram.Telegram-iOS.Premium",
            "enable_siri": true,
            "enable_icloud": true
          }' > build-system/telegram-configuration.json

      # 8. Generate Xcode Project (Fixed with Fake Signing)
      - name: Generate Xcode Project
        run: |
          python3 build-system/Make/Make.py \
            generateProject \
            --configurationPath=build-system/telegram-configuration.json \
            --codesigningInformationPath=build-system/fake-codesigning \
            --disableProvisioningProfiles

      # 9. Verify Compilation
      - name: Verify Compilation (TelegramUI)
        run: |
          xcodebuild build \
            -workspace Telegram.xcworkspace \
            -scheme TelegramUI \
            -destination 'generic/platform=iOS Simulator' \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty
